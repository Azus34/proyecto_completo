# ==========================================
# GitHub Actions - CI/CD Pipeline
# ==========================================
# Blue-Green Deployment con Zero Downtime
# ==========================================

name: CI/CD Pipeline - Blue-Green

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  VPS_HOST: 167.172.198.138
  VPS_USER: deployer
  PROJECT_PATH: /var/www/proyecto_completo

jobs:
  # ==================== JOB 1: Tests ====================
  test:
    name: ğŸ§ª Ejecutar Tests
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ“¦ Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ“š Instalar dependencias
        run: npm ci

      - name: ğŸ§ª Ejecutar tests
        run: npm test

  # ==================== JOB 2: Blue-Green Deploy ====================
  deploy:
    name: ğŸš€ Blue-Green Deploy
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ”‘ Configurar SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}

      - name: ğŸ”’ Agregar host conocido
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ env.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: ğŸ” Detectar entorno activo
        id: detect
        run: |
          ACTIVE=$(ssh ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "curl -s http://localhost:3001/health 2>/dev/null | grep -o 'BLUE' || echo 'NONE'")
          if [ "$ACTIVE" = "BLUE" ]; then
            echo "current=BLUE" >> $GITHUB_OUTPUT
            echo "target=GREEN" >> $GITHUB_OUTPUT
            echo "target_port=3002" >> $GITHUB_OUTPUT
            echo "current_port=3001" >> $GITHUB_OUTPUT
          else
            echo "current=GREEN" >> $GITHUB_OUTPUT
            echo "target=BLUE" >> $GITHUB_OUTPUT
            echo "target_port=3001" >> $GITHUB_OUTPUT
            echo "current_port=3002" >> $GITHUB_OUTPUT
          fi
          echo "ğŸ”µ Entorno actual: $ACTIVE"

      - name: ğŸ“¦ Desplegar nueva versiÃ³n en ${{ steps.detect.outputs.target }}
        run: |
          ssh ${{ env.VPS_USER }}@${{ env.VPS_HOST }} << 'ENDSSH'
            cd ${{ env.PROJECT_PATH }} || mkdir -p ${{ env.PROJECT_PATH }} && cd ${{ env.PROJECT_PATH }}
            
            # Actualizar cÃ³digo
            if [ -d ".git" ]; then
              git pull origin main
            else
              git clone https://github.com/${{ github.repository }}.git .
            fi
            
            # Construir y levantar ambos entornos
            docker-compose up -d --build
            
            echo "âœ… Contenedores desplegados"
          ENDSSH

      - name: â³ Esperar health check de ${{ steps.detect.outputs.target }}
        run: |
          echo "Esperando que ${{ steps.detect.outputs.target }} estÃ© healthy..."
          for i in {1..30}; do
            HEALTH=$(ssh ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "curl -s http://localhost:${{ steps.detect.outputs.target_port }}/health 2>/dev/null || echo 'waiting'")
            if echo "$HEALTH" | grep -q "OK"; then
              echo "âœ… ${{ steps.detect.outputs.target }} estÃ¡ healthy!"
              exit 0
            fi
            echo "Intento $i/30..."
            sleep 2
          done
          echo "âŒ Health check fallÃ³"
          exit 1

      - name: ğŸ”„ Switch de trÃ¡fico a ${{ steps.detect.outputs.target }}
        run: |
          ssh ${{ env.VPS_USER }}@${{ env.VPS_HOST }} << ENDSSH
            # Actualizar Nginx para apuntar al nuevo entorno
            sudo tee /etc/nginx/conf.d/service.conf << 'EOF'
          # ==========================================
          # Blue-Green Deployment - Nginx Config
          # Entorno activo: ${{ steps.detect.outputs.target }}
          # ==========================================

          upstream active_backend {
              server 127.0.0.1:${{ steps.detect.outputs.target_port }} max_fails=3 fail_timeout=30s;
              keepalive 32;
          }

          server {
              listen 80;
              listen [::]:80;
              server_name ${{ env.VPS_HOST }};

              location /health {
                  proxy_pass http://active_backend;
              }

              location / {
                  proxy_pass http://active_backend;
                  proxy_http_version 1.1;
                  proxy_set_header Host \$host;
                  proxy_set_header X-Real-IP \$remote_addr;
                  proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
              }
          }
          EOF
            
            # Verificar y recargar Nginx
            sudo nginx -t && sudo systemctl reload nginx
            
            echo "âœ… TrÃ¡fico cambiado a ${{ steps.detect.outputs.target }}"
          ENDSSH

      - name: âœ… Verificar deployment
        run: |
          sleep 3
          RESPONSE=$(curl -s http://${{ env.VPS_HOST }}/health)
          echo "Respuesta: $RESPONSE"
          if echo "$RESPONSE" | grep -q "OK"; then
            echo "âœ… Deployment exitoso!"
            echo "ğŸ”µ Entorno anterior: ${{ steps.detect.outputs.current }}"
            echo "ğŸŸ¢ Entorno activo: ${{ steps.detect.outputs.target }}"
          else
            echo "âŒ VerificaciÃ³n fallÃ³"
            exit 1
          fi

      - name: ğŸ“Š Resumen del Deploy
        run: |
          echo "============================================"
          echo "ğŸ‰ BLUE-GREEN DEPLOYMENT COMPLETADO"
          echo "============================================"
          echo "ğŸ“ Servidor: http://${{ env.VPS_HOST }}"
          echo "ğŸ”µ BLUE: http://${{ env.VPS_HOST }}:3001"
          echo "ğŸŸ¢ GREEN: http://${{ env.VPS_HOST }}:3002"
          echo "âœ… Activo: ${{ steps.detect.outputs.target }}"
          echo "============================================"

      - name: âœ… Verificar deployment
        run: |
          sleep 10
          curl -f http://167.172.198.138/health || echo "âš ï¸ Health check pendiente"
