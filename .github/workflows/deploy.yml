# ==========================================
# GitHub Actions - CI/CD Pipeline
# ==========================================
# Blue-Green Deployment con Zero Downtime
# ==========================================

name: CI/CD Pipeline - Blue-Green

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  VPS_HOST: 167.172.198.138
  VPS_USER: deployer
  PROJECT_PATH: /var/www/proyecto_completo

jobs:
  # ==================== JOB 1: Tests ====================
  test:
    name: üß™ Ejecutar Tests
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout c√≥digo
        uses: actions/checkout@v4

      - name: üì¶ Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: üìö Instalar dependencias
        run: npm ci

      - name: üß™ Ejecutar tests
        run: npm test

  # ==================== JOB 2: Blue-Green Deploy ====================
  deploy:
    name: üöÄ Blue-Green Deploy
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: üì• Checkout c√≥digo
        uses: actions/checkout@v4

      - name: üîë Configurar SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}

      - name: üîí Agregar host conocido
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ env.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: üîç Detectar entorno activo
        id: detect
        run: |
          # Verificar cu√°l entorno est√° activo en el puerto 80 (Nginx)
          ACTIVE=$(ssh ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "curl -s http://localhost/health 2>/dev/null | grep -oE 'BLUE|GREEN' || echo 'NONE'")
          echo "Entorno activo en puerto 80: $ACTIVE"
          if [ "$ACTIVE" = "GREEN" ]; then
            echo "current=GREEN" >> $GITHUB_OUTPUT
            echo "target=BLUE" >> $GITHUB_OUTPUT
            echo "target_port=3001" >> $GITHUB_OUTPUT
            echo "current_port=3002" >> $GITHUB_OUTPUT
          else
            echo "current=BLUE" >> $GITHUB_OUTPUT
            echo "target=GREEN" >> $GITHUB_OUTPUT
            echo "target_port=3002" >> $GITHUB_OUTPUT
            echo "current_port=3001" >> $GITHUB_OUTPUT
          fi
          echo "üîµ Entorno actual: $ACTIVE ‚Üí Cambiaremos a: $([ "$ACTIVE" = "GREEN" ] && echo "BLUE" || echo "GREEN")"

      - name: üì¶ Desplegar nueva versi√≥n en ${{ steps.detect.outputs.target }}
        run: |
          ssh ${{ env.VPS_USER }}@${{ env.VPS_HOST }} << 'ENDSSH'
            cd ${{ env.PROJECT_PATH }} || mkdir -p ${{ env.PROJECT_PATH }} && cd ${{ env.PROJECT_PATH }}
            
            # Actualizar c√≥digo
            if [ -d ".git" ]; then
              git pull origin main
            else
              git clone https://github.com/${{ github.repository }}.git .
            fi
            
            # Construir y levantar ambos entornos
            docker-compose up -d --build
            
            echo "‚úÖ Contenedores desplegados"
          ENDSSH

      - name: ‚è≥ Esperar health check de ${{ steps.detect.outputs.target }}
        run: |
          echo "Esperando que ${{ steps.detect.outputs.target }} est√© healthy..."
          for i in {1..30}; do
            HEALTH=$(ssh ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "curl -s http://localhost:${{ steps.detect.outputs.target_port }}/health 2>/dev/null || echo 'waiting'")
            if echo "$HEALTH" | grep -q "OK"; then
              echo "‚úÖ ${{ steps.detect.outputs.target }} est√° healthy!"
              exit 0
            fi
            echo "Intento $i/30..."
            sleep 2
          done
          echo "‚ùå Health check fall√≥"
          exit 1

      - name: üîÑ Switch de tr√°fico a ${{ steps.detect.outputs.target }}
        run: |
          ssh ${{ env.VPS_USER }}@${{ env.VPS_HOST }} << ENDSSH
            # Actualizar Nginx para apuntar al nuevo entorno
            sudo tee /etc/nginx/conf.d/service.conf << 'EOF'
          # ==========================================
          # Blue-Green Deployment - Nginx Config
          # Entorno activo: ${{ steps.detect.outputs.target }}
          # ==========================================

          upstream active_backend {
              server 127.0.0.1:${{ steps.detect.outputs.target_port }} max_fails=3 fail_timeout=30s;
              keepalive 32;
          }

          server {
              listen 80;
              listen [::]:80;
              server_name ${{ env.VPS_HOST }};

              location /health {
                  proxy_pass http://active_backend;
              }

              location / {
                  proxy_pass http://active_backend;
                  proxy_http_version 1.1;
                  proxy_set_header Host \$host;
                  proxy_set_header X-Real-IP \$remote_addr;
                  proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
              }
          }
          EOF
            
            # Verificar y recargar Nginx
            sudo nginx -t && sudo systemctl reload nginx
            
            echo "‚úÖ Tr√°fico cambiado a ${{ steps.detect.outputs.target }}"
          ENDSSH

      - name: ‚úÖ Verificar deployment
        run: |
          sleep 3
          RESPONSE=$(curl -s http://${{ env.VPS_HOST }}/health)
          echo "Respuesta: $RESPONSE"
          if echo "$RESPONSE" | grep -q "OK"; then
            echo "‚úÖ Deployment exitoso!"
            echo "üîµ Entorno anterior: ${{ steps.detect.outputs.current }}"
            echo "üü¢ Entorno activo: ${{ steps.detect.outputs.target }}"
          else
            echo "‚ùå Verificaci√≥n fall√≥"
            exit 1
          fi

      - name: üìä Resumen del Deploy
        run: |
          echo "============================================"
          echo "üéâ BLUE-GREEN DEPLOYMENT COMPLETADO"
          echo "============================================"
          echo "üìç Servidor: http://${{ env.VPS_HOST }}"
          echo "üîµ BLUE: http://${{ env.VPS_HOST }}:3001"
          echo "üü¢ GREEN: http://${{ env.VPS_HOST }}:3002"
          echo "‚úÖ Activo: ${{ steps.detect.outputs.target }}"
          echo "============================================"

      - name: ‚úÖ Verificar deployment
        run: |
          sleep 10
          curl -f http://167.172.198.138/health || echo "‚ö†Ô∏è Health check pendiente"
